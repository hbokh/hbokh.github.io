<!DOCTYPE html>
<html lang="en-us">
<head>

    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    
    
        
        <meta name="twitter:card" content="summary_large_image"/>
        <meta name="twitter:image" content="/images/waitress.jpg"/>
    



<meta name="twitter:title" content="Pixiecore &amp; waitron"/>
<meta name="twitter:description" content=""/>
<meta name="twitter:site" content="@BOK"/>



  	<meta property="og:title" content="Pixiecore &amp; waitron &middot; BOK" />
  	<meta property="og:site_name" content="BOK" />
  	<meta property="og:url" content="https://hbokh.github.io/post/2018/12/01/pixiecore-waitron/" />

    
       <meta property="og:image" content="/images/waitress.jpg"/>
    

    
    <meta property="og:description" content="" />
  	<meta property="og:type" content="article" />
    <meta property="article:published_time" content="2018-12-01T20:45:00Z" />

    
    <meta property="article:tag" content="PXE" />
    
    <meta property="article:tag" content="tech" />
    
    

    <title>Pixiecore &amp; waitron &middot; BOK</title>

    
    <meta name="description" content="&lt;p&gt;Blahblah&lt;/p&gt;" />
    

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="https://hbokh.github.io/images/favicon.ico">
	  <link rel="apple-touch-icon" href="https://hbokh.github.io/images/apple-touch-icon.png" />

    <link rel="stylesheet" type="text/css" href="https://hbokh.github.io/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="https://hbokh.github.io/css/nav.css" />

    

    
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/styles/monokai.min.css">
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/highlight.min.js"></script>
        
        <script>hljs.initHighlightingOnLoad();</script>
    

    
      
          <link href="https://hbokh.github.io/index.xml" rel="alternate" type="application/rss+xml" title="BOK" />
      
      
    
    <meta name="generator" content="Hugo 0.52" />

    <link rel="canonical" href="https://hbokh.github.io/post/2018/12/01/pixiecore-waitron/" />

    
      
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": ,
        "logo": https://hbokh.github.io/images/bok.png
    },
    "author": {
        "@type": "Person",
        "name": ,
        
        "image": {
            "@type": "ImageObject",
            "url": https://hbokh.github.io/images/bok.png,
            "width": 250,
            "height": 250
        }, 
        
        "url": ,
        "sameAs": [
            
            
             
             
             
             
             
            
        ],
        "description": Recovering sysadmin
        
    },
    "headline": Pixiecore &amp; waitron,
    "name": Pixiecore &amp; waitron,
    "wordCount": 849,
    "timeRequired": "PT4M",
    "inLanguage": {
      "@type": "Language",
      "alternateName": en
    },
    "url": https://hbokh.github.io/post/2018/12/01/pixiecore-waitron/,
    "datePublished": 2018-12-01T20:45Z,
    "dateModified": 2018-12-01T20:45Z,
    
    "image": {
        "@type": "ImageObject",
        "url": https://hbokh.github.io/images/waitress.jpg,
        "width": 3000,
        "height": 1445
    },
    
    "keywords": PXE, tech,
    "description": ,
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": https://hbokh.github.io/post/2018/12/01/pixiecore-waitron/
    }
}
    </script>
    


    

    

    
</head>
<body class="nav-closed">

  <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        
        
        
            <h3>Topics</h3>
            <li class="nav-opened" role="presentation">
            	<a href="https://hbokh.github.io/">Blog</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
            	<a href="https://hbokh.github.io/about">About me</a>
            </li>
        
            <h3>Follow me</h3>
            <li class="nav-opened" role="presentation">
            	<a href="https://github.com/hbokh">GitHub repos</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
            	<a href="https://twitter.com/BOK">Twitter</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
            	<a href="https://keybase.io/hbokh">Keybase</a>
            </li>
        
        
    </ul>

    
    <a class="subscribe-button icon-feed" href="https://hbokh.github.io/index.xml">Subscribe</a>
    
</div>
<span class="nav-cover"></span>


 <div class="site-wrapper">



  
  <header class="main-header post-head" style="background-image: url(/images/waitress.jpg)">
  
  <nav class="main-nav overlay clearfix">


  
      <a class="blog-logo" href="https://hbokh.github.io/"><img src="https://hbokh.github.io/images/bok.png" alt="Home" /></a>
  
  
      <a class="menu-button" href="#"><span class="burger">&#9776;</span><span class="word">Menu</span></a>
  
  </nav>
</header>



<main class="content" role="main">




  <article class="post post">

    <header class="post-header">
        <h1 class="post-title">Pixiecore &amp; waitron</h1>
        <small></small>

        <section class="post-meta">
        
          <time class="post-date" datetime="2018-12-01T20:45:00Z">
            Dec 1, 2018
          </time>
        
         
          <span class="post-tag small"><a href="https://hbokh.github.io//tags/pxe/">#PXE</a></span>
         
          <span class="post-tag small"><a href="https://hbokh.github.io//tags/tech/">#tech</a></span>
         
        </section>
    </header>

    <section class="post-content">
      <p>Blahblah</p>

<h1 id="pixiecore-waitron">Pixiecore &amp; waitron</h1>

<p>*<strong><em>WORK. IN. PROGRESS.</em></strong>*</p>

<h2 id="repositories">Repositories</h2>

<ul>
<li><a href="https://github.com/google/netboot/tree/master/pixiecore">netboot/pixiecron</a></li>
<li><a href="https://github.com/gdoucet/waitron">waitron</a></li>
</ul>

<h2 id="used-hardware">Used hardware</h2>

<p>I installed both &ldquo;Pixiecron&rdquo; &amp; &ldquo;waitron&rdquo; on a small box running Ubuntu 16.04 Xenial, named <code>dc2.internal</code>.<br />
DC2? Yes, see <a href="https://www.kickstarter.com/projects/dickhardt/dc2-desktop-container-computer-for-docker-containe">DC2 - Desktop Container Computer for Docker Containers</a>.</p>

<p>Testing was done on VMs running on a <a href="https://www.proxmox.com/en/proxmox-ve">Proxmox Virtual Environment</a> (version 5.2-12).</p>

<p>Go-binary build on a MacBook Pro (Intel Core i7, 16GB RAM).</p>

<h2 id="install-pixiecore">Install Pixiecore</h2>

<p>Check instructions at <a href="https://github.com/google/netboot/tree/master/pixiecore">https://github.com/google/netboot/tree/master/pixiecore</a> on how it&rsquo;s done.</p>

<p>This box will both run &ldquo;Pixiecron&rdquo; and &ldquo;waitron&rdquo; from the manually created directory <code>/opt/waitron/</code>.<br />
&ldquo;Pixiecron&rdquo; will run as an API-<strong>client</strong> and &ldquo;waitron&rdquo; an an API-<strong>server</strong>.</p>

<h2 id="build-waitron">Build waitron</h2>

<p>Make sure you have Go installed.<br />
Because I only want a Linux x86-64 executable file, but my most powerful computer is a MacBook Pro, I go through these somewhat different steps in building &ldquo;waitron&rdquo;. On my Mac:</p>

<pre><code class="language-txt">cd $GOPATH/src/github.com
mkdir jhaals
cd jhaals
git clone https://github.com/jhaals/waitron.git
cd waitron
</code></pre>

<blockquote>
<p><strong>IMPORTANT</strong><br />
I made changes in 2 Go-files. Only the first one is needed!</p>
</blockquote>

<p>In <code>machine.go</code> line 84 and in <code>main.go</code> line 254:</p>

<pre><code class="language-patch">diff --git a/machine.go b/machine.go
index 7d2eeff..ddfdd52 100644
--- a/machine.go
+++ b/machine.go
@@ -81,7 +81,7 @@ func (m Machine) renderTemplate(template string, config Config) (string, error)
 // Posts machine macaddress to the forman proxy among with pxe configuration
 func (m Machine) setBuildMode(config Config) error {
        // Generate a random token used to authenticate requests
-       config.Tokens[m.Hostname] = uuid.NewV4().String()
+       config.Tokens[m.Hostname] = uuid.Must(uuid.NewV4()).String()
        log.Println(fmt.Sprintf(&quot;%s installation token: %s&quot;, m.Hostname, config.Tokens[m.Hostname]))
        // Add token to machine struct
        m.Token = config.Tokens[m.Hostname]
diff --git a/main.go b/main.go
index 35a23df..8a53094 100644
--- a/main.go
+++ b/main.go
@@ -251,5 +251,5 @@ func main() {
                })

        log.Println(&quot;Starting Server&quot;)
-       log.Fatal(http.ListenAndServe(&quot;:9090&quot;, handlers.LoggingHandler(os.Stdout, r)))
+       log.Fatal(http.ListenAndServe(&quot;:8090&quot;, handlers.LoggingHandler(os.Stdout, r)))
 }
}
</code></pre>

<ul>
<li>The line reading &ldquo;uuid&rdquo; needs to be made compatible with the latest release of <code>github.com/satori/go.uuid</code>. If not you&rsquo;ll get the error <code>./machine.go:84:40: multiple-value uuid.NewV4() in single-value context</code>.</li>
<li>The Ubuntu box also runs Prometheus, listening on port 9090, so I had to alter this (the port can not be overruled in the config&hellip;).</li>
</ul>

<pre><code class="language-txt">$ go get -v
github.com/flosch/pongo2 (download)
github.com/juju/errors (download)
github.com/gorilla/handlers (download)
github.com/julienschmidt/httprouter (download)
github.com/satori/go.uuid (download)
</code></pre>

<p>As stated I want a Linux- binary, so I ran the build like this:</p>

<p><code>env GOOS=linux GOARCH=amd64 go build .</code></p>

<p>This left me with a 9.8M sized binary named &ldquo;waitron&rdquo;.<br />
Next I scp-ed this binary to the Ubuntu-box: <code>scp waitron dc2:/opt/waitron/</code></p>

<h3 id="configurations">Configurations</h3>

<p>File <code>config.yaml</code>. Adapted, because the <code>default_cmdline</code> would offer a wrongly URL:</p>

<pre><code class="language-yaml">templatepath: templates
machinepath: machines
baseurl: http://dc2.internal:8090
params:
    apt_hostname: &quot;nl.archive.ubuntu.com&quot;
    apt_path: &quot;/ubuntu/&quot;
    dns_nameservers: &quot;192.168.178.3&quot;
    ntp_server: &quot;nl.pool.ntp.org&quot;
default_cmdline: &quot;interface=auto url={{ BaseURL }}/template/preseed/{{ Hostname }}/{{ Token }} ramdisk_size=10800 root=/dev/rd/0 rw auto hostname={{ Hostname }} console-setup/ask_detect=false console-setup/layout=USA console-setup/variant=USA keyboard-configuration/layoutcode=us localechooser/translation/warn-light=true localechooser/translation/warn-severe=true locale=en_US&quot;
default_kernel: linux
default_image_url: http://archive.ubuntu.com/ubuntu/dists/trusty-updates/main/installer-amd64/current/images/netboot/ubuntu-installer/amd64/
default_initrd: initrd.gz
</code></pre>

<p>File <code>machines/linux001.internal.yaml</code>. Here the defaults from the config above are overruled:</p>

<pre><code class="language-yaml">hostname: linux001.internal
operatingsystem: &quot;Stretch&quot;
preseed: debian9.j2
finish: finish.j2
#BaseURL is this waitron instance url, it is read from the config file
#Hostname is the hostname for this very host, it is read from this file
#Token is generated at runtime by waitron
cmdline: &quot;interface=auto url={{ BaseURL }}/template/preseed/{{ Hostname }}/{{ Token }} locale=en_US.UTF-8 debian/priority=critical vga=normal debian-installer/keymap=us console-keymaps-at/keymap=us keyboard-configuration/xkb-keymap=us console-setup/layoutcode=en_US localechooser/translation/warn-light=true localechooser/translation/warn-severe=true console-setup/ask_detect=false netcfg/get_hostname={{ Hostname }} netcfg/get_domain=internal FRONTEND_BACKGROUND=original&quot;
image_url: http://bsd002.internal:81/debian/stretch/amd64/
kernel: linux
initrd: initrd.gz
network:
  - name: eth0
    ipaddress: 192.168.178.141
    macaddress: 00:de:ad:90:74:60
    netmask: 255.255.255.0
    gateway: 192.168.178.1
params:
    foo: False
    bar: &quot;Hello world&quot;
    static: True
</code></pre>

<p>I also added a Debian-specific <a href="https://wiki.debian.org/DebianInstaller/Preseed">preseed</a>-file to <code>templates/debian9.j2</code> and left it with the Jinja2-extension.</p>

<h2 id="start-me-up">Start me up</h2>

<p>In seperate terminals:</p>

<ol>
<li><p>Start Pixiecore: <code>pixiecore api http://dc2.internal:8090/ -d --dhcp-no-bind</code></p></li>

<li><p>Start waitron: <code>env CONFIG_FILE=config.yaml ./waitron -d</code></p></li>
</ol>

<h2 id="set-build-mode">Set build mode</h2>

<p>First, a new system needs to be set in &ldquo;build mode&rdquo; before it is offered anything from Pixiecore. Lets use <code>curl</code> for that:</p>

<pre><code class="language-txt">$ curl -X PUT http://dc2.internal:8090/build/linux001.internal
OK
</code></pre>

<p>Make sure you&rsquo;re using the same name as used for the machine-definition, otherwise you&rsquo;ll get an error like this:</p>

<pre><code class="language-txt">$ curl -X PUT http://dc2.internal:8090/build/linux001
Unable to find host definition for linux001
</code></pre>

<p>To check the status I use <a href="https://httpie.org/">HTTPie</a>:</p>

<pre><code class="language-txt">$ http http://dc2.internal:8090/status
{
    &quot;linux001.internal&quot;: &quot;Installing&quot;
}
</code></pre>

<h3 id="output">Output</h3>

<p>Some output that &ldquo;Pixiecore&rdquo; could show:</p>

<pre><code class="language-txt">[Init] Starting Pixiecore goroutines
[DHCP] Got valid request to boot 00:de:ad:90:74:60 (IA32)
[DHCP] Offering to boot 00:de:ad:90:74:60
[DHCP] Ignoring packet from 00:de:ad:90:74:60: packet is DHCPREQUEST, not DHCPDISCOVER
[TFTP] Sent &quot;00:de:ad:90:74:60/4&quot; to 192.168.178.52:27591
[DHCP] Got valid request to boot 00:de:ad:90:74:60 (IA32)
[DHCP] Offering to boot 00:de:ad:90:74:60
[DHCP] Ignoring packet from 00:de:ad:90:74:60: packet is DHCPREQUEST, not DHCPDISCOVER
[HTTP] Get bootspec for 00:de:ad:90:74:60 took 4.678411ms
[HTTP] Construct ipxe script for 00:de:ad:90:74:60 took 350.408µs
[HTTP] Sending ipxe boot script to 192.168.178.52:1659
[HTTP] Writing ipxe script to 00:de:ad:90:74:60 took 42.322µs
[HTTP] handleIpxe for 00:de:ad:90:74:60 took 5.400122ms
[HTTP] Sent file &quot;tW7vpWPYGEL2lfVpyjq-FglAVRynuLOVoxRLmnzfpPmObFHeAlZbGxXqcyC-h-fZSO5eXPPKtQZyaQyxpEDyfYVS4tVIr6xd5j6RgcJAnBcDvZv7CuF5&quot; to 192.168.178.52:1659
[HTTP] Sent file &quot;ebLmUhO9mx1xGPx2nFcjoIXDR0LZ9xaUSOV1Cr2RmiI2h1i_2KvmHob6pG5mCOGR5cziycJaA7HvB3-nSn_j8oXlmIfUFFvhGJlx1uaG-OB57MOp-S-W&quot; to 192.168.178.52:1659
</code></pre>

<p>And the same for &ldquo;waitron&rdquo;:</p>

<pre><code class="language-txt">2018/12/01 17:26:00 Starting Server
2018/12/01 17:26:04 linux001.internal installation token: 73f267c2-1ea3-40c2-8c5e-2f134a5e8ee7
192.168.178.21 - - [01/Dec/2018:17:26:04 +0100] &quot;PUT /build/linux001.internal HTTP/1.1&quot; 200 2
192.168.178.21 - - [01/Dec/2018:17:26:13 +0100] &quot;GET /template/preseed/linux001.internal/73f267c2-1ea3-40c2-8c5e-2f134a5e8ee7 HTTP/1.1&quot; 200 2879
192.168.178.199 - - [01/Dec/2018:17:27:02 +0100] &quot;GET /v1/boot/00:de:ad:90:74:60 HTTP/1.1&quot; 200 697
192.168.178.199 - - [01/Dec/2018:17:27:03 +0100] &quot;GET /v1/boot/00:de:ad:90:74:60 HTTP/1.1&quot; 200 697
192.168.178.199 - - [01/Dec/2018:17:27:03 +0100] &quot;GET /v1/boot/00:de:ad:90:74:60 HTTP/1.1&quot; 200 697
192.168.178.52 - - [01/Dec/2018:17:27:44 +0100] &quot;GET /template/preseed/linux001.internal/73f267c2-1ea3-40c2-8c5e-2f134a5e8ee7 HTTP/1.1&quot; 200 2879
192.168.178.21 - - [01/Dec/2018:17:31:28 +0100] &quot;GET /status HTTP/1.1&quot; 200 34
</code></pre>

<hr />

<p>HB, 20181201</p>
    </section>


  <footer class="post-footer">


    








<figure class="author-image">
    <a class="img" href="https://hbokh.github.io/" style="background-image: url(/images/bok.png)"><span class="hidden">Henk's Picture</span></a>
</figure>


<section class="author">
  <h4><a href="https://hbokh.github.io/">Henk</a></h4>
  
  <p>Recovering sysadmin</p>
  
  <div class="author-meta">
    <span class="author-location icon-location">Groningen, the Netherlands</span>
    
  </div>
</section>




    


    





  </footer>
</article>

</main>


  <aside class="read-next">
  
  
      <a class="read-next-story prev" style="background-image: url(/images/cobbler.jpg)" href="https://hbokh.github.io/post/2017/08/26/server-provisioning-at-spindle/">
          <section class="post">
              <h2>Server provisioning at Spindle</h2>
          </section>
      </a>
  
</aside>



    <footer class="site-footer clearfix">
        <section class="copyright"><a href="">BOK</a> All rights reserved</section>
        
        <section class="poweredby">Proudly generated by <a class="icon-hugo" href="http://gohugo.io">HUGO</a>, with <a class="icon-theme" href="https://github.com/vjeantet/hugo-theme-casper">Casper</a> theme</section>
        
    </footer>
    </div>
    <script type="text/javascript" src="https://hbokh.github.io/js/jquery.js"></script>
    <script type="text/javascript" src="https://hbokh.github.io/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="https://hbokh.github.io/js/index.js"></script>
    
</body>
</html>

